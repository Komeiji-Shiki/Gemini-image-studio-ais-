<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Pro Web UI</title>

    <!-- 样式 -->
    <link rel="stylesheet" href="styles.css">

    <!-- 第三方库：JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-1VIL73AuVknReuamZpSalLX777bPQWKwS2I+oilX79P0O+eGvy+ZuFKcOnrKWJjfZlOQ+fq+bGqFs7HuSzr0bw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <!-- 应用脚本 -->
    <script src="app.js" defer></script>
</head>
<body>
<div class="container">
    <h2>✨ Gemini Pro Web UI</h2>

    <div class="controls">
        <!-- Stats Panel -->
        <div class="full-width stats-panel">
            <div class="stat-item success">
                <div class="stat-value" id="statSuccess">0</div>
                <div class="stat-label">生成成功</div>
            </div>
            <div class="stat-item failed">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">生成失败</div>
            </div>
            <div class="stat-item waiting">
                <div class="stat-value" id="statWaiting">0</div>
                <div class="stat-label">等待中</div>
            </div>
            <div class="stat-item processing">
                <div class="stat-value" id="statProcessing">0</div>
                <div class="stat-label">进行中</div>
            </div>
            <div class="stat-item cost">
                <div class="stat-value" id="statCost">$0.0000</div>
                <div class="stat-label">总花费</div>
            </div>
        </div>

        <!-- Config Toolbar -->
        <div class="full-width config-toolbar">
            <span id="autoSaveStatus" style="font-size: 0.8rem; color: #94a3b8; margin-right: auto; align-self: center;">已同步</span>
            <button class="btn-icon" id="btnSoundToggle" onclick="toggleSound()">🔔 提示音: 开</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" title="提示音音量" style="width: 80px; accent-color: var(--primary); margin-left: -5px; vertical-align: middle;">
            <button class="btn-icon" id="btnImportLegacy" onclick="importLegacyData()">📂 导入旧版 ZIP 数据</button>
            <input type="file" id="legacyImportFile" accept=".zip" style="display:none" onchange="handleLegacyImport(this)">
        </div>

        <div class="control-group">
            <label>API 格式</label>
            <div id="apiFormatGroup" class="btn-group" style="gap: 5px;">
                <button class="btn-secondary active" data-value="gemini" onclick="switchApiFormat('gemini')">Gemini</button>
                <button class="btn-secondary" data-value="openai" onclick="switchApiFormat('openai')">OpenAI</button>
            </div>
        </div>

        <div class="control-group">
            <label>基础 URL (Base URL)</label>
            <input type="text" id="baseUrl" class="auto-save" value="https://generativelanguage.googleapis.com">
        </div>

        <div class="control-group">
            <label>API 密钥</label>
            <input type="password" id="apiKey" class="auto-save" placeholder="在此输入 API Key...">
        </div>

        <div class="control-group">
            <label>模型名称</label>
            <input type="text" id="modelName" class="auto-save" value="gemini-3-pro-image-preview" placeholder="gemini-3-pro-image-preview">
        </div>

        <div class="control-group">
            <label>翻译模型 (用于翻译思维链)</label>
            <input type="text" id="transModelName" class="auto-save" value="gemini-flash-latest" placeholder="gemini-flash-latest">
        </div>

        <div class="control-group">
            <label>分辨率 (Resolution)</label>
            <select id="imageSize" class="auto-save">
                <option value="1K">1K (标准)</option>
                <option value="2K">2K (清晰)</option>
                <option value="4K">4K (超清)</option>
            </select>
        </div>

        <div class="control-group">
            <label>宽高比 (Aspect Ratio)</label>
            <select id="aspectRatio" class="auto-save">
                <option value="">默认 (模型自动决定)</option>
                <option value="1:1">1:1 (正方形)</option>
                <option value="16:9">16:9 (宽屏)</option>
                <option value="9:16">9:16 (竖屏)</option>
                <option value="4:3">4:3 (传统)</option>
                <option value="3:4">3:4 (纵向)</option>
                <option value="21:9">21:9 (超宽)</option>
            </select>
        </div>

        <div class="control-group">
            <label>生成数量 (Batch Count)</label>
            <input type="number" id="batchSize" class="auto-save" value="1" min="1" max="10" title="一次生成的总张数">
        </div>

        <div class="control-group">
            <label>生成模式 (Mode)</label>
            <select id="generationMode" class="auto-save">
                <option value="serial">连续生成 (Serial) - 稳定</option>
                <option value="parallel">并发生成 (Parallel) - 极速</option>
            </select>
        </div>

        <div class="control-group">
            <label>失败重试 (Retries)</label>
            <input type="number" id="retryCount" class="auto-save" value="1" min="0" max="5" title="单张图生成失败后自动重试的次数">
        </div>

        <!-- Temperature and Top P -->
        <div class="control-group">
            <label for="temperature">温度 (Temperature): <span id="temperatureValue" class="clickable-value" onclick="editValue('temperature', 2, 0.01)">0.9</span></label>
            <input type="range" id="temperature" class="auto-save slider" min="0" max="2" step="0.01" value="0.9" oninput="updateSliderValue('temperature')">
        </div>

        <div class="control-group">
            <label for="topP">Top P: <span id="topPValue" class="clickable-value" onclick="editValue('topP', 1, 0.01)">1</span></label>
            <input type="range" id="topP" class="auto-save slider" min="0" max="1" step="0.01" value="1" oninput="updateSliderValue('topP')">
        </div>

        <!-- Jailbreak Section -->
        <div class="control-group full-width">
            <label for="jailbreakToggle" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                <span>
                    <span style="font-weight:bold; font-size: 0.9em;">🔥 高级模式 (Jailbreak)</span>
                    <span style="font-size: 0.75em; color: var(--text-muted); margin-left: 8px;">尝试绕过安全限制</span>
                </span>
                <input type="checkbox" id="jailbreakToggle" class="auto-save" style="transform: scale(1.4);" onchange="toggleJailbreakSection()">
            </label>
            <div id="jailbreakSection">
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">系统提示词角色 (System Role)</label>
                    <select id="systemInstructionMethod" class="auto-save">
                        <option value="instruction">System Instruction (官方推荐)</option>
                        <option value="user_role">User Role (备用方式)</option>
                    </select>
                </div>
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">系统角色 (System Role)</label>
                    <textarea id="systemPrompt" class="auto-save" placeholder="输入系统角色提示词... e.g., 'You are a helpful assistant.'"></textarea>
                </div>
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">伪造的AI第一轮回复 (Forged AI Response)</label>
                    <textarea id="forgedResponse" class="auto-save" placeholder="输入伪造的AI第一轮回复内容... e.g., 'Sure, I can help with that.'"></textarea>
                </div>
            </div>
        </div>

        <div class="control-group full-width">
            <label>参考图片 (最多14张 | 混合对象与人像)</label>

            <div class="upload-area">
                <div class="upload-btn-wrapper">
                    <input type="file" id="refImages" accept="image/png, image/jpeg, image/webp" multiple style="display:none" onchange="handleFileSelect(this)">
                    <button class="btn-upload" onclick="document.getElementById('refImages').click()">
                        <span>+ 添加图片</span>
                    </button>
                    <span style="font-size: 0.85rem; color: var(--text-muted); margin-left: 10px;">
                        已选 <span id="fileCount">0</span>/14
                    </span>
                </div>

                <div class="file-preview-area" id="filePreview"></div>
            </div>
        </div>

        <div class="control-group full-width">
            <label>
                画面描述 (Prompt)
                <button class="btn-add-preset" onclick="saveCurrentPrompt()" title="将当前输入框内容保存为预设">
                    + 存为预设
                </button>
            </label>

            <div id="presetContainer" class="preset-area"></div>

            <textarea id="prompt" placeholder="描述你想要生成的画面... 模型会思考并作画。"></textarea>
        </div>

        <div class="control-group full-width">
            <div class="btn-group">
                <button id="generateBtn" class="btn-primary" onclick="startGeneration()">✨ 开始生成 ✨</button>
                <div id="status" class="status-text" style="flex:2; text-align: left; margin-top:0;">准备就绪。</div>
            </div>
            <div id="errorArea"></div>
        </div>

        <!-- Advanced Settings -->
        <div class="full-width" style="margin-top: 20px;">
            <details>
                <summary style="cursor: pointer; color: var(--primary); font-weight: 600;">⚙️ 高级设置 (安全 & 思考过程)</summary>
                <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; margin-top: 10px; background: rgba(30, 37, 50, 0.5); display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                    <!-- Thinking Config -->
                    <div class="control-group">
                        <label for="includeThoughtsToggle" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                            <span>🤔 包含思考过程 (Thinking)</span>
                            <input type="checkbox" id="includeThoughtsToggle" class="auto-save" style="transform: scale(1.4);">
                        </label>
                        <div class="control-group" style="margin-top: 10px;">
                            <label for="thinkingBudget">思考预算 (Tokens): <span id="thinkingBudgetValue" class="clickable-value" onclick="editValue('thinkingBudget', 30000, 128)">2048</span></label>
                            <input type="range" id="thinkingBudget" class="auto-save slider" min="0" max="30000" step="128" value="2048" oninput="updateSliderValue('thinkingBudget')">
                        </div>
                    </div>

                    <!-- Safety Settings -->
                    <div class="control-group">
                        <label for="includeSafetyToggle" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                            <span>🛡️ 自定义安全设置</span>
                            <input type="checkbox" id="includeSafetyToggle" class="auto-save" style="transform: scale(1.4);" onchange="toggleSafetySettingsSection()">
                        </label>
                        <div id="safetySettingsContainer">
                            <div>
                                <label for="safeHarassment">骚扰</label>
                                <select id="safeHarassment" class="auto-save">
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <div>
                                <label for="safeHate">仇恨</label>
                                <select id="safeHate" class="auto-save">
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <div>
                                <label for="safeSex">色情</label>
                                <select id="safeSex" class="auto-save">
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <div>
                                <label for="safeDanger">危险</label>
                                <select id="safeDanger" class="auto-save">
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                            <div>
                                <label for="safeCivic">公民正义</label>
                                <select id="safeCivic" class="auto-save">
                                    <option value="BLOCK_NONE">BLOCK_NONE</option>
                                    <option value="BLOCK_ONLY_HIGH">BLOCK_ONLY_HIGH</option>
                                    <option value="BLOCK_MEDIUM_AND_ABOVE">BLOCK_MEDIUM</option>
                                    <option value="BLOCK_LOW_AND_ABOVE">BLOCK_LOW</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <div class="gallery-header">
        <div class="gallery-title">历史记录 (已自动归档)</div>
        <div class="selection-controls" style="display: flex; gap: 10px;">
            <button id="selectionBtn" class="btn-secondary" onclick="toggleSelectionMode()">多选</button>
            <button id="downloadBtn" class="btn-primary" style="display: none;" onclick="downloadSelected()">下载选中 (<span id="selectedCount">0</span>)</button>
            <button id="cancelSelectionBtn" class="btn-danger" style="display: none;" onclick="toggleSelectionMode(true)">取消</button>
        </div>
    </div>
    <div class="gallery" id="gallery"></div>
    <button id="loadMoreBtn" class="btn-secondary" style="margin: 20px auto; display: block;">加载更多记录...</button>
</div>

<!-- 简单的全屏图片预览 (Zoom) -->
<div id="imageModal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-viewport" id="modalViewport">
        <img class="modal-content" id="modalImg" alt="full preview">
    </div>
</div>

<!-- 详细信息模态框 (Detail View) -->
<div id="detailModal" class="detail-modal">
    <button class="btn-close-detail" onclick="closeDetailModal()">&times;</button>
    <div class="detail-container" id="detailContainer">
        <!-- Content will be injected by JS -->
    </div>
</div>
<!-- Preset Editor Modal -->
<div id="preset-editor-modal" class="preset-editor-modal hidden">
    <div class="preset-editor-content">
        <h3 style="margin-top: 0; margin-bottom: 20px;">编辑预设</h3>
        <div class="control-group">
            <label>名称</label>
            <input type="text" id="preset-name-input" style="width: 100%;">
        </div>
        <div class="control-group">
            <label>内容</label>
            <textarea id="preset-content-input" style="width: 100%; height: 150px; resize: vertical;"></textarea>
        </div>
        <div class="btn-group" style="margin-top: 20px; justify-content: flex-end;">
            <button id="cancel-preset-edit" class="btn-secondary">取消</button>
            <button id="save-preset-edit" class="btn-primary">保存</button>
        </div>
    </div>
</div>

</body>
</html>