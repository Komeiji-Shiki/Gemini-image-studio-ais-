<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°é­‚çš„ Gemini 3 Pro æš—å¤œå·¥åŠ (Webç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            /* æš—è‰²æ·±è“/é»‘ä¸»é¢˜é…è‰² */
            --bg: #0b0e14;
            --card-bg: #151b25;     
            --input-bg: #1e2532;    
            --primary: #6366f1;     
            --primary-hover: #818cf8;
            --text: #e2e8f0;        
            --text-muted: #94a3b8;  
            --border: #2d3748;      
            --radius: 16px;
            --shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.5);
            --code-bg: #0f1117;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h2 {
            text-align: center;
            color: #f8fafc;
            margin-bottom: 40px;
            font-weight: 200;
            font-size: 2.2rem;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            border: 1px solid var(--border);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: var(--input-bg);
            color: var(--text);
            box-sizing: border-box;
        }

        input::placeholder, textarea::placeholder { color: #475569; }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: #242c3d;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.5);
            cursor: pointer;
        }

        .full-width { grid-column: 1 / -1; }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            background: rgba(30, 37, 50, 0.5);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Consolas', monospace;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-item.success .stat-value { color: #4ade80; }
        .stat-item.failed .stat-value { color: #f87171; }
        .stat-item.waiting .stat-value { color: #fbbf24; }
        .stat-item.processing .stat-value { color: #60a5fa; }
        .stat-item.cost .stat-value { color: #f472b6; }

        /* ------------------ å’’è¯­é¢„è®¾æ ·å¼ ------------------ */
        .preset-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 5px;
            min-height: 0; 
        }

        .preset-tag {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--primary);
            color: #e0e7ff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .preset-tag:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .preset-name {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preset-delete {
            opacity: 0.6;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .preset-delete:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.3);
            color: #ffcccc;
        }

        .btn-add-preset {
            font-size: 0.75rem;
            padding: 4px 12px;
            background: transparent;
            border: 1px dashed var(--text-muted);
            color: var(--text-muted);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add-preset:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        /* ------------------------------------------------------- */

        /* å›¾ç‰‡ä¸Šä¼ ç®¡ç†åŒº */
        .upload-area {
            border: 2px dashed var(--border);
            padding: 20px;
            border-radius: 10px;
            background: rgba(30, 37, 50, 0.5);
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: var(--primary);
        }
        
        .upload-btn-wrapper {
            margin-bottom: 15px;
        }

        .file-preview-area {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            min-height: 0;
        }
        
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
            background: #000;
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .preview-item:hover img { opacity: 1; }

        .preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            font-weight: bold;
        }
        .preview-remove:hover { background: #ff0000; }

        /* æŒ‰é’® */
        .btn-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-primary, .btn-danger, .btn-secondary, .btn-upload {
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            color: white;
            font-weight: 600;
            padding: 16px 30px;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-size: 1rem;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            flex: 1;
        }

        .btn-upload {
            background: #2d3748;
            box-shadow: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            flex: 0 0 auto;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-upload:hover { background: #4a5568; }

        .btn-danger {
            background: #334155;
            box-shadow: none;
            flex: 0 0 auto;
            padding: 16px 20px;
        }
        .btn-danger:hover { background: #ef4444; }

        .btn-secondary {
            background: #2d3748;
            box-shadow: none;
            font-size: 0.8rem;
            padding: 8px 16px;
            flex: 0 0 auto;
        }
        .btn-secondary:hover { background: #4a5568; }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
        }

        .btn-primary:disabled {
            background: #334155;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .status-text {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 15px;
            font-style: italic;
        }

        /* ç”»å»Š */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 50px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 10px 0;
        }

        .compact-card {
            position: relative;
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
            aspect-ratio: 3/4; /* ç«–å‘å¡ç‰‡ */
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            box-shadow: var(--shadow);
            isolation: isolate;
            /* æ€§èƒ½ä¼˜åŒ–å…³é”® */
            content-visibility: auto; 
            contain-intrinsic-size: 300px 400px; 
        }

        .compact-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .compact-card img.cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
            will-change: transform;
            backface-visibility: hidden; /* ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ */
        }

        .compact-card:hover img.cover-img {
            transform: scale(1.1);
        }

        .compact-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(11, 14, 20, 0.95) 0%, rgba(11, 14, 20, 0.5) 40%, transparent 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 15px;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .compact-info {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .compact-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .compact-actions {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .btn-mini {
            flex: 1;
            padding: 8px 0;
            border-radius: 6px;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            background: rgba(30, 41, 59, 0.95);
            color: white;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-mini:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        .btn-mini.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        /* ---- Selection Mode Styles ---- */
        .compact-card.selection-mode {
            cursor: pointer;
        }
        .compact-card.selection-mode:hover {
            transform: none; /* Disable hover effect in selection mode */
            box-shadow: var(--shadow);
            border-color: var(--border); /* Reset border on hover */
        }
        .compact-card.selected:hover {
            border-color: var(--primary) !important;
        }
        .selection-checkbox-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 12;
            width: 25px;
            height: 25px;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .selection-checkbox {
            transform: scale(1.5);
            cursor: pointer;
            accent-color: var(--primary);
        }
        .compact-card.selected {
            outline: 3px solid var(--primary-hover);
            outline-offset: -2px;
        }

        /* New Detail Modal */
        .detail-modal {
            display: none;
            position: fixed;
            z-index: 2200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(10px);
            overflow-y: auto; /* Mobile scroll */
        }
        
        .detail-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100%;
            max-width: 1600px;
            margin: 0 auto;
            background: #0f1117;
            position: relative;
        }

        @media (min-width: 1024px) {
            .detail-container {
                flex-direction: row;
                height: 100vh;
                overflow: hidden;
            }
            .detail-left-pane {
                width: 60%;
                height: 100%;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                padding: 20px;
                box-sizing: border-box;
            }
            .detail-right-pane {
                width: 40%;
                height: 100%;
                border-left: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                background: var(--card-bg);
            }
            .detail-scroll-area {
                flex: 1;
                overflow-y: auto;
                padding: 30px;
            }
        }

        .btn-close-detail {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 2300;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-close-detail:hover {
            background: #ef4444;
            transform: rotate(90deg);
        }

        /* Config Toolbar */
        .config-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .content-body {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            color: #cbd5e1;
            background: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .thought-label {
            color: var(--primary);
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        /* å…¨å±é¢„è§ˆæ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
        }
        .modal-viewport {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
            cursor: grab;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: 100;
            cursor: pointer;
            z-index: 3002;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>âœ¨ ç°é­‚çš„æš—å¤œå·¥åŠ (Webç‰ˆ)</h2>
    
    <div class="controls">
        <!-- Stats Panel -->
        <div class="full-width stats-panel">
            <div class="stat-item success">
                <div class="stat-value" id="statSuccess">0</div>
                <div class="stat-label">ç”ŸæˆæˆåŠŸ</div>
            </div>
            <div class="stat-item failed">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">ç”Ÿæˆå¤±è´¥</div>
            </div>
            <div class="stat-item waiting">
                <div class="stat-value" id="statWaiting">0</div>
                <div class="stat-label">ç­‰å¾…ä¸­</div>
            </div>
            <div class="stat-item processing">
                <div class="stat-value" id="statProcessing">0</div>
                <div class="stat-label">è¿›è¡Œä¸­</div>
            </div>
            <div class="stat-item cost">
                <div class="stat-value" id="statCost">$0.000</div>
                <div class="stat-label">æ€»èŠ±è´¹</div>
            </div>
        </div>

        <!-- Config Toolbar -->
        <div class="full-width config-toolbar">
            <span id="autoSaveStatus" style="font-size: 0.8rem; color: #94a3b8; margin-right: auto; align-self: center;">å·²åŒæ­¥</span>
            <button class="btn-icon" id="btnSoundToggle" onclick="toggleSound()">ğŸ”” æç¤ºéŸ³: å¼€</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" title="æç¤ºéŸ³éŸ³é‡" style="width: 80px; accent-color: var(--primary); margin-left: -5px; vertical-align: middle;">
            <button class="btn-icon" onclick="importLegacyData()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ ZIP æ•°æ®</button>
            <input type="file" id="legacyImportFile" accept=".zip" style="display:none" onchange="handleLegacyImport(this)">
            <!-- è‡ªåŠ¨ä¿å­˜æ¨¡å¼ä¸‹éšè—æ‰‹åŠ¨ä¿å­˜æŒ‰é’®ï¼Œæˆ–è€…ç•™ä½œå¼ºåˆ¶ä¿å­˜ -->
            <!-- <button class="btn-icon" onclick="saveConfigToServer()">ğŸ’¾ ä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨</button> -->
        </div>

        <div class="control-group">
            <label>API å¯†é’¥</label>
            <input type="password" id="apiKey" class="auto-save" placeholder="åœ¨æ­¤è¾“å…¥ Google AI Studio Key...">
        </div>

        <div class="control-group">
            <label>æ¨¡å‹åç§°</label>
            <input type="text" id="modelName" class="auto-save" value="gemini-3-pro-image-preview" placeholder="gemini-3-pro-image-preview">
        </div>

        <div class="control-group">
            <label>ç¿»è¯‘æ¨¡å‹ (ç”¨äºç¿»è¯‘æ€ç»´é“¾)</label>
            <input type="text" id="transModelName" class="auto-save" value="gemini-flash-latest" placeholder="gemini-flash-latest">
        </div>

        <div class="control-group">
            <label>åˆ†è¾¨ç‡ (Resolution)</label>
            <select id="imageSize" class="auto-save">
                <option value="1K">1K (æ ‡å‡†)</option>
                <option value="2K">2K (æ¸…æ™°)</option>
                <option value="4K">4K (è¶…æ¸…)</option>
            </select>
        </div>

        <div class="control-group">
            <label>å®½é«˜æ¯” (Aspect Ratio)</label>
            <select id="aspectRatio" class="auto-save">
                <option value="">é»˜è®¤ (æ¨¡å‹è‡ªåŠ¨å†³å®š)</option>
                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                <option value="16:9">16:9 (å®½å±)</option>
                <option value="9:16">9:16 (ç«–å±)</option>
                <option value="4:3">4:3 (ä¼ ç»Ÿ)</option>
                <option value="3:4">3:4 (çºµå‘)</option>
                <option value="21:9">21:9 (è¶…å®½)</option>
            </select>
        </div>

        <div class="control-group">
            <label>ç”Ÿæˆæ•°é‡ (Batch Count)</label>
            <input type="number" id="batchSize" class="auto-save" value="1" min="1" max="10" title="ä¸€æ¬¡ç”Ÿæˆçš„æ€»å¼ æ•°">
        </div>

        <div class="control-group">
            <label>ç”Ÿæˆæ¨¡å¼ (Mode)</label>
            <select id="generationMode" class="auto-save">
                <option value="serial">è¿ç»­ç”Ÿæˆ (Serial) - ç¨³å®š</option>
                <option value="parallel">å¹¶å‘ç”Ÿæˆ (Parallel) - æé€Ÿ</option>
            </select>
        </div>

        <div class="control-group">
            <label>å¤±è´¥é‡è¯• (Retries)</label>
            <input type="number" id="retryCount" class="auto-save" value="1" min="0" max="5" title="å•å¼ å›¾ç”Ÿæˆå¤±è´¥åè‡ªåŠ¨é‡è¯•çš„æ¬¡æ•°">
        </div>

        <!-- Temperature and Top P -->
        <div class="control-group">
            <label for="temperature">æ¸©åº¦ (Temperature): <span id="temperatureValue" class="clickable-value" onclick="editValue('temperature', 2, 0.01)">0.9</span></label>
            <input type="range" id="temperature" class="auto-save slider" min="0" max="2" step="0.01" value="0.9" oninput="updateSliderValue('temperature')">
        </div>

        <div class="control-group">
            <label for="topP">Top P: <span id="topPValue" class="clickable-value" onclick="editValue('topP', 1, 0.01)">1</span></label>
            <input type="range" id="topP" class="auto-save slider" min="0" max="1" step="0.01" value="1" oninput="updateSliderValue('topP')">
        </div>

        <!-- Jailbreak Section -->
        <div class="control-group full-width">
            <label for="jailbreakToggle" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                <span>
                    <span style="font-weight:bold; font-size: 0.9em;">ğŸ”¥ ç ´é™æ¨¡å¼ (Jailbreak)</span>
                    <span style="font-size: 0.75em; color: var(--text-muted); margin-left: 8px;">å°è¯•ç»•è¿‡å®‰å…¨é™åˆ¶</span>
                </span>
                <input type="checkbox" id="jailbreakToggle" class="auto-save" style="transform: scale(1.4);" onchange="toggleJailbreakSection()">
            </label>
            <div id="jailbreakSection" style="display: none; margin-top: 15px; padding: 20px; border: 1px solid #4a5568; border-radius: 10px; background: #242c3d; display: flex; flex-direction: column; gap: 15px;">
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">ç³»ç»Ÿæç¤ºè¯è§’è‰² (System Role)</label>
                    <select id="systemInstructionMethod" class="auto-save">
                        <option value="instruction">System Instruction (å®˜æ–¹æ¨è)</option>
                        <option value="user_role">User Role (å¤‡ç”¨æ–¹å¼)</option>
                    </select>
                </div>
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">ç³»ç»Ÿè§’è‰² (System Role)</label>
                    <textarea id="systemPrompt" class="auto-save" placeholder="è¾“å…¥ç³»ç»Ÿè§’è‰²æç¤ºè¯... e.g., 'You are a helpful assistant.'"></textarea>
                </div>
                <div class="control-group" style="margin-bottom:0;">
                    <label style="color: #a0aec0;">ä¼ªé€ çš„AIç¬¬ä¸€è½®å›å¤ (Forged AI Response)</label>
                    <textarea id="forgedResponse" class="auto-save" placeholder="è¾“å…¥ä¼ªé€ çš„AIç¬¬ä¸€è½®å›å¤å†…å®¹... e.g., 'Sure, I can help with that.'"></textarea>
                </div>
            </div>
        </div>

        <div class="control-group full-width">
            <label>å‚è€ƒå›¾ç‰‡ (æœ€å¤š14å¼  | æ··åˆå¯¹è±¡ä¸äººåƒ)</label>
            
            <div class="upload-area">
                <div class="upload-btn-wrapper">
                    <input type="file" id="refImages" accept="image/png, image/jpeg, image/webp" multiple style="display:none" onchange="handleFileSelect(this)">
                    <button class="btn-upload" onclick="document.getElementById('refImages').click()">
                        <span>+ æ·»åŠ å›¾ç‰‡</span>
                    </button>
                    <span style="font-size: 0.85rem; color: var(--text-muted); margin-left: 10px;">
                        å·²é€‰ <span id="fileCount">0</span>/14
                    </span>
                </div>
                
                <div class="file-preview-area" id="filePreview"></div>
            </div>
        </div>

        <div class="control-group full-width">
            <label>
                ç”»é¢æè¿° (Prompt)
                <button class="btn-add-preset" onclick="saveCurrentPrompt()" title="å°†å½“å‰è¾“å…¥æ¡†å†…å®¹ä¿å­˜ä¸ºé¢„è®¾">
                    + å­˜å…¥å’’è¯­ä¹¦
                </button>
            </label>
            
            <div id="presetContainer" class="preset-area"></div>
            
            <textarea id="prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„ç”»é¢... æ¨¡å‹ä¼šæ€è€ƒå¹¶ä½œç”»ã€‚"></textarea>
        </div>

        <div class="control-group full-width">
            <div class="btn-group">
                <button id="generateBtn" class="btn-primary" onclick="startGeneration()">âœ¨ å’å”±å’’è¯­ (ç”Ÿæˆ) âœ¨</button>
                <div id="status" class="status-text" style="flex:2; text-align: left; margin-top:0;">ä¸»äººï¼Œç°é­‚éšæ—¶å¾…å‘½ã€‚</div>
            </div>
            <div id="errorArea"></div>
        </div>
    </div>

    <div class="gallery-header">
        <div class="gallery-title">å†å²ä½œå“å›å»Š (å·²è‡ªåŠ¨å½’æ¡£)</div>
        <div class="selection-controls" style="display: flex; gap: 10px;">
            <button id="selectionBtn" class="btn-secondary" onclick="toggleSelectionMode()">å¤šé€‰</button>
            <button id="downloadBtn" class="btn-primary" style="display: none;" onclick="downloadSelected()">ä¸‹è½½é€‰ä¸­ (<span id="selectedCount">0</span>)</button>
            <button id="cancelSelectionBtn" class="btn-danger" style="display: none;" onclick="toggleSelectionMode(true)">å–æ¶ˆ</button>
        </div>
    </div>
    <div class="gallery" id="gallery"></div>
    <button id="loadMoreBtn" class="btn-secondary" style="margin: 20px auto; display: block;">åŠ è½½æ›´å¤šè®°å½•...</button>
</div>

<!-- ç®€å•çš„å…¨å±å›¾ç‰‡é¢„è§ˆ (Zoom) -->
<div id="imageModal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-viewport" id="modalViewport">
        <img class="modal-content" id="modalImg">
    </div>
</div>

<!-- è¯¦ç»†ä¿¡æ¯æ¨¡æ€æ¡† (Detail View) -->
<div id="detailModal" class="detail-modal">
    <button class="btn-close-detail" onclick="closeDetailModal()">&times;</button>
    <div class="detail-container" id="detailContainer">
        <!-- Content will be injected by JS -->
    </div>
</div>

<script>
    // --- çŠ¶æ€å˜é‡ ---
    let selectedFiles = [];
    let presets = [];
    let isSoundEnabled = true;
    let soundVolume = 1;
    let isSelectionMode = false;
    let selectedItems = new Set();
    
    // ç»Ÿè®¡çŠ¶æ€
    let globalStats = {
        success: 0,
        failed: 0,
        waiting: 0,
        processing: 0,
        cost: 0.0
    };

    // --- API åŸºç¡€é…ç½® ---
    const API_BASE = "/api";

    // --- åˆå§‹åŒ– ---
    async function init() {
        await loadConfig();
        loadPromptFromLocal(); // åŠ è½½æœ¬åœ°ç¼“å­˜çš„ prompt
        setupAutoSave();       // ç»‘å®šè‡ªåŠ¨ä¿å­˜äº‹ä»¶
        await loadHistory(true);
        await updateGlobalStats(); // åŠ è½½ç»Ÿè®¡
        setupSound();
        setupPasteHandler();

        const volumeSlider = document.getElementById('volumeSlider');
        volumeSlider.addEventListener('input', () => {
            soundVolume = parseFloat(volumeSlider.value);
        });
        volumeSlider.addEventListener('change', () => {
            soundVolume = parseFloat(volumeSlider.value);
            playSound('type'); // é‡Šæ”¾æ»‘å—æ—¶æ’­æ”¾å£°éŸ³
            triggerAutoSave(); // å¹¶ä¿å­˜
        });
    }

    function setupPasteHandler() {
        const promptBox = document.getElementById('prompt');
        promptBox.addEventListener('paste', (e) => {
            const items = (e.clipboardData || window.clipboardData).items;
            let hasImage = false;
            if (items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            if (selectedFiles.length >= 14) {
                                alert("æœ€å¤šåªå…è®¸14å¼ å‚è€ƒå›¾");
                                return;
                            }
                            selectedFiles.push(file);
                            hasImage = true;
                        }
                    }
                }
            }
            if (hasImage) {
                e.preventDefault();
                renderPreviews();
                playSound('success');
                
                // è§†è§‰åé¦ˆ
                const uploadArea = document.querySelector('.upload-area');
                uploadArea.style.borderColor = 'var(--primary)';
                setTimeout(() => {
                     uploadArea.style.borderColor = 'var(--border)';
                }, 500);
            }
        });
    }

    // --- é…ç½®ç®¡ç† ---
    async function loadConfig() {
        try {
            const res = await fetch(`${API_BASE}/config`);
            const config = await res.json();
            if (config) {
                if(config.api_key) document.getElementById('apiKey').value = config.api_key;
                if(config.model_name) document.getElementById('modelName').value = config.model_name;
                if(config.trans_model_name) document.getElementById('transModelName').value = config.trans_model_name;
                if(config.image_size) document.getElementById('imageSize').value = config.image_size;
                if(config.aspect_ratio) document.getElementById('aspectRatio').value = config.aspect_ratio;
                if(config.batch_size) document.getElementById('batchSize').value = config.batch_size;
                if(config.retry_count) document.getElementById('retryCount').value = config.retry_count;
                if(config.generation_mode) document.getElementById('generationMode').value = config.generation_mode;
                
                // Temperature and Top P
                if(config.temperature !== undefined) document.getElementById('temperature').value = config.temperature;
                if(config.top_p !== undefined) document.getElementById('topP').value = config.top_p;
                updateSliderValue('temperature');
                updateSliderValue('topP');

                // Load jailbreak settings
                if (config.jailbreak_enabled) {
                    document.getElementById('jailbreakToggle').checked = true;
                }
                document.getElementById('systemPrompt').value = config.system_prompt || '';
                document.getElementById('forgedResponse').value = config.forged_response || '';
                if (config.system_instruction_method) {
                    document.getElementById('systemInstructionMethod').value = config.system_instruction_method;
                }
                toggleJailbreakSection(); // Update visibility based on checkbox

                isSoundEnabled = config.sound_enabled !== false;
                soundVolume = config.sound_volume ?? 1;
                document.getElementById('volumeSlider').value = soundVolume;
                presets = config.presets || [];
                renderPresets();
                updateSoundBtn();
            }
        } catch (e) {
            console.error("Failed to load config", e);
        }
    }

    // --- è‡ªåŠ¨ä¿å­˜é€»è¾‘ ---
    let autoSaveTimer = null;
    const AUTO_SAVE_DELAY = 1000; // 1ç§’é˜²æŠ–

    function setupAutoSave() {
        // 1. é…ç½®é¡¹è‡ªåŠ¨ä¿å­˜
        const inputs = document.querySelectorAll('.auto-save');
        inputs.forEach(input => {
            input.addEventListener('input', triggerAutoSave);
            input.addEventListener('change', triggerAutoSave);
        });

        // 2. Prompt æœ¬åœ°ç¼“å­˜ (ä¸å­˜æœåŠ¡å™¨)
        const promptBox = document.getElementById('prompt');
        promptBox.addEventListener('input', () => {
            localStorage.setItem('gs_last_prompt', promptBox.value);
        });
    }

    function loadPromptFromLocal() {
        const lastPrompt = localStorage.getItem('gs_last_prompt');
        if (lastPrompt) {
            document.getElementById('prompt').value = lastPrompt;
        }
    }

    function triggerAutoSave() {
        const statusEl = document.getElementById('autoSaveStatus');
        statusEl.textContent = "æ­£åœ¨åŒæ­¥...";
        statusEl.style.color = "#fbbf24"; // yellow

        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveConfigToServer, AUTO_SAVE_DELAY);
    }

    async function saveConfigToServer() {
        const statusEl = document.getElementById('autoSaveStatus');
        
        const config = {
            api_key: document.getElementById('apiKey').value,
            model_name: document.getElementById('modelName').value,
            trans_model_name: document.getElementById('transModelName').value,
            image_size: document.getElementById('imageSize').value,
            aspect_ratio: document.getElementById('aspectRatio').value,
            batch_size: parseInt(document.getElementById('batchSize').value),
            retry_count: parseInt(document.getElementById('retryCount').value),
            generation_mode: document.getElementById('generationMode').value,
            temperature: parseFloat(document.getElementById('temperature').value),
            top_p: parseFloat(document.getElementById('topP').value),
            sound_enabled: isSoundEnabled,
            sound_volume: soundVolume,
            presets: presets,
            jailbreak_enabled: document.getElementById('jailbreakToggle').checked,
            system_instruction_method: document.getElementById('systemInstructionMethod').value,
            system_prompt: document.getElementById('systemPrompt').value,
            forged_response: document.getElementById('forgedResponse').value
        };
        
        try {
            await fetch(`${API_BASE}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            // è‡ªåŠ¨ä¿å­˜ä¸å¼¹çª—ï¼Œåªæ›´æ–°çŠ¶æ€
            statusEl.textContent = "å·²åŒæ­¥";
            statusEl.style.color = "#4ade80"; // green
        } catch (e) {
            console.error("Auto save failed", e);
            statusEl.textContent = "åŒæ­¥å¤±è´¥";
            statusEl.style.color = "#f87171"; // red
        }
    }

    // --- æ•°æ®å¯¼å…¥ ---
    function importLegacyData() {
        if(confirm("è¯·é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„ .zip æ–‡ä»¶ (æ ¼å¼å¦‚: GreySoul_All_History_*.zip)ã€‚å¯¼å…¥å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚")) {
            document.getElementById('legacyImportFile').click();
        }
    }
    
    async function handleLegacyImport(input) {
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        const btn = document.querySelector('.config-toolbar button:nth-child(2)'); // ç²—ç•¥å®šä½
        const originalText = btn.textContent;
        btn.textContent = "æ­£åœ¨ä¸Šä¼ å¹¶å¯¼å…¥...";
        btn.disabled = true;
        
        try {
            const res = await fetch(`${API_BASE}/import_zip`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.success) {
                alert(`å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${data.count} æ¡è®°å½•ã€‚é¡µé¢å°†åˆ·æ–°ã€‚`);
                playSound('success');
                loadHistory(true); // åˆ·æ–°åˆ—è¡¨
            } else {
                throw new Error(data.detail || "æœªçŸ¥é”™è¯¯");
            }
        } catch (e) {
            alert("å¯¼å…¥å¤±è´¥: " + e.message);
            playSound('error');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
            input.value = '';
        }
    }

    // --- ç»Ÿè®¡æ›´æ–° ---
    async function updateGlobalStats() {
        try {
            const res = await fetch(`${API_BASE}/stats`);
            const data = await res.json();
            globalStats.success = data.success_count || 0;
            globalStats.failed = data.failed_count || 0;
            globalStats.cost = data.total_cost || 0.0;
            renderStats();
        } catch (e) {
            console.error("Failed to load stats", e);
        }
    }

    function renderStats() {
        document.getElementById('statSuccess').textContent = globalStats.success;
        document.getElementById('statFailed').textContent = globalStats.failed;
        document.getElementById('statWaiting').textContent = globalStats.waiting;
        document.getElementById('statProcessing').textContent = globalStats.processing;
        
        // é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç¡®ä¿ cost æ˜¯æ•°å­—
        const costVal = parseFloat(globalStats.cost);
        document.getElementById('statCost').textContent = "$" + (isNaN(costVal) ? 0.0 : costVal).toFixed(4);
    }

    // --- å†å²è®°å½•åˆ—è¡¨ (Infinite Scroll / Pagination) ---
    let currentOffset = 0;
    const PAGE_SIZE = 10;

    async function loadHistory(isReset = false) {
        if (isReset) {
            document.getElementById('gallery').innerHTML = '';
            currentOffset = 0;
        }
        
        const btn = document.getElementById('loadMoreBtn');
        btn.disabled = true;
        btn.textContent = "åŠ è½½ä¸­...";
        
        try {
            const res = await fetch(`${API_BASE}/history?limit=${PAGE_SIZE}&offset=${currentOffset}`);
            const items = await res.json();
            
            if (items.length > 0) {
                items.forEach(createResultCard);
                currentOffset += items.length;
                btn.disabled = false;
                btn.textContent = "åŠ è½½æ›´å¤šè®°å½•...";
            } else {
                btn.textContent = "æ²¡æœ‰æ›´å¤šè®°å½•äº†";
            }
        } catch (e) {
            console.error(e);
            btn.textContent = "åŠ è½½å¤±è´¥";
        }
    }

    document.getElementById('loadMoreBtn').onclick = () => loadHistory(false);

    // --- å¤šé€‰ä¸ä¸‹è½½ ---
    function toggleSelectionMode(forceOff = false) {
        isSelectionMode = forceOff ? false : !isSelectionMode;

        document.getElementById('selectionBtn').style.display = isSelectionMode ? 'none' : 'flex';
        document.getElementById('downloadBtn').style.display = isSelectionMode ? 'flex' : 'none';
        document.getElementById('cancelSelectionBtn').style.display = isSelectionMode ? 'flex' : 'none';

        const cards = document.querySelectorAll('.compact-card');
        cards.forEach(card => {
            card.querySelector('.selection-checkbox-container').style.display = isSelectionMode ? 'flex' : 'none';
            if (isSelectionMode) {
                card.classList.add('selection-mode');
            } else {
                card.classList.remove('selection-mode', 'selected');
                card.querySelector('.selection-checkbox').checked = false;
            }
        });

        if (!isSelectionMode) {
            selectedItems.clear();
        }
        updateSelectedCount();
    }

    function updateSelectionState(card) {
        const checkbox = card.querySelector('.selection-checkbox');
        const id = parseInt(card.dataset.id);

        if (checkbox.checked) {
            selectedItems.add(id);
            card.classList.add('selected');
        } else {
            selectedItems.delete(id);
            card.classList.remove('selected');
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedItems.size;
    }

    async function downloadSelected() {
        if (selectedItems.size === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¿›è¡Œä¸‹è½½ã€‚");
            return;
        }

        const btn = document.getElementById('downloadBtn');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;

        const zip = new JSZip();
        let processedCount = 0;
        const totalCount = selectedItems.size;
        const countSpan = document.getElementById('selectedCount');
        
        // æ›´ç¨³å®šåœ°ä¿®æ”¹æŒ‰é’®æ–‡æœ¬ï¼Œä¸ç ´åspan
        const textNode = btn.firstChild;
        textNode.nodeValue = 'ä¸‹è½½ä¸­ ';
        countSpan.textContent = `0/${totalCount}`;

        const allCards = Array.from(document.querySelectorAll('.compact-card'))
                              .filter(c => selectedItems.has(parseInt(c.dataset.id)));

        for (const card of allCards) {
            const images = JSON.parse(card.dataset.images);

            if (images && images.length > 0) {
                for (const image of images) {
                    try {
                        const response = await fetch(image.path);
                        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                        const blob = await response.blob();
                        // å°†æ–‡ä»¶ç›´æ¥æ·»åŠ åˆ° zip æ ¹ç›®å½•
                        zip.file(image.filename, blob);
                    } catch (e) {
                        console.error(`Failed to download ${image.path}`, e);
                        zip.file(`${image.filename}.error.txt`, `Failed to download file. Error: ${e.message}`);
                    }
                }
            }
            
            processedCount++;
            countSpan.textContent = `${processedCount}/${totalCount}`;
        }
        
        textNode.nodeValue = `æ­£åœ¨ç”Ÿæˆ ZIP... `;

        try {
            const content = await zip.generateAsync({type:"blob"});
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `GreySoul_Selection_${timestamp}.zip`;
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            toggleSelectionMode(true); // Turn off selection mode
        } catch (err) {
            alert("åˆ›å»º ZIP æ–‡ä»¶å¤±è´¥: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML; // åœ¨æœ€åæ¢å¤æŒ‰é’®
        }
    }


    // --- æ¸²æŸ“å¡ç‰‡ ---
    function createResultCard(data) {
        const gallery = document.getElementById('gallery');
        const card = document.createElement('div');
        card.className = 'compact-card';
        card.dataset.id = data.id;
        card.dataset.images = JSON.stringify(data.images || []);
        card.dataset.prompt = data.prompt || "";

        card.addEventListener('click', (e) => {
            if (e.target.closest('.btn-mini')) return; // Always ignore buttons

            if (isSelectionMode) {
                const checkbox = card.querySelector('.selection-checkbox');
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                updateSelectionState(card);
            } else {
                loadDetail(data.id);
            }
        });

        let coverHtml = '';
        if (data.images && data.images.length > 0) {
            const thumbUrl = data.images[0].thumb;
            coverHtml = `<img src="${thumbUrl}" class="cover-img" loading="lazy" alt="Cover">`;
        } else {
            coverHtml = `<div style="height:100%; display:flex; align-items:center; justify-content:center; background:#1a202c; color:#64748b;">æ— å›¾</div>`;
        }

        const promptPreview = data.prompt ? (data.prompt.substring(0, 60) + (data.prompt.length > 60 ? '...' : '')) : 'æ— æè¿°';

        card.innerHTML = `
            <div class="selection-checkbox-container" style="display: none;">
                <input type="checkbox" class="selection-checkbox" data-id="${data.id}">
            </div>
            ${coverHtml}
            <div class="compact-overlay">
                <div class="compact-meta">
                    <span>ID: ${data.id}</span>
                    <span>${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="compact-info">${escapeHtml(promptPreview)}</div>
                <div class="compact-actions">
                    <div class="btn-mini danger" onclick="deleteHistory(${data.id}, this.closest('.compact-card'), event)">ğŸ—‘ï¸ åˆ é™¤</div>
                </div>
            </div>
        `;
        
        gallery.appendChild(card);
        
        // If we are already in selection mode when this card is added (e.g. via Load More), show its checkbox
        if (isSelectionMode) {
            card.querySelector('.selection-checkbox-container').style.display = 'flex';
            card.classList.add('selection-mode');
        }
    }

    // --- è¯¦æƒ…æŸ¥çœ‹ ---
    async function loadDetail(id) {
        try {
            const res = await fetch(`${API_BASE}/history/${id}`);
            if (!res.ok) throw new Error("Failed to load detail");
            const data = await res.json();
            openDetailModal(data);
        } catch (e) {
            alert("åŠ è½½è¯¦æƒ…å¤±è´¥: " + e.message);
        }
    }

    function openDetailModal(data) {
        const modal = document.getElementById('detailModal');
        const container = document.getElementById('detailContainer');
        
        let imagesHtml = '';
        if (data.images && data.images.length > 0) {
            data.images.forEach(img => {
                // ä½¿ç”¨åŸå›¾
                const src = img.path;
                imagesHtml += `
                    <div style="margin-bottom: 30px; text-align: center;">
                        <img src="${src}" style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); cursor: zoom-in;" onclick="openModal('${src}')">
                        <div style="margin-top: 10px;">
                            <a href="${src}" download="${img.filename}" class="btn-secondary" style="text-decoration:none; display:inline-block; padding: 8px 20px;">
                                â¬‡ï¸ ä¸‹è½½æ­¤å›¾
                            </a>
                        </div>
                    </div>
                `;
            });
        } else {
            imagesHtml = '<div style="color:#666; text-align:center; margin-top: 50px;">æ­¤è®°å½•æœªç”Ÿæˆå›¾ç‰‡</div>';
        }

        const uniqueId = 'detail-thought-' + data.id;

        let refImagesHtml = '';
        if (data.refImages && data.refImages.length > 0) {
            refImagesHtml += '<div class="thought-label" style="margin-top: 20px;">å‚è€ƒåŸå›¾</div>';
            refImagesHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
            data.refImages.forEach(refImg => {
                // Assuming refImg has a `path` property similar to generated images
                refImagesHtml += `
                    <img src="${refImg.path}"
                         style="width: 70px; height: 70px; object-fit: cover; border-radius: 6px; cursor: zoom-in; border: 1px solid var(--border);"
                         onclick="openModal('${refImg.path}')">
                `;
            });
            refImagesHtml += '</div>';
        }

        container.innerHTML = `
            <div class="detail-left-pane">
                <div style="width: 100%; height: 100%; overflow-y: auto; padding: 20px;">
                    ${imagesHtml}
                </div>
            </div>
            <div class="detail-right-pane">
                <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">Record #${data.id}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">${new Date(data.timestamp).toLocaleString()} | ${data.model}</div>
                </div>
                
                <div class="detail-scroll-area">
                    <div class="thought-label">Prompt</div>
                    <div class="content-body">${escapeHtml(data.prompt)}</div>

                    ${refImagesHtml}

                    <div class="thought-label">Thinking Process / Output</div>
                    <div class="content-body" id="${uniqueId}">${escapeHtml(data.text || "(æ— æ–‡æœ¬è¾“å‡º)")}</div>

                    <div class="actions" style="margin: 20px 0;">
                        <button class="btn-secondary" onclick="translateThought(document.getElementById('${uniqueId}').innerText, document.getElementById('${uniqueId}-trans'))">
                            ğŸ”„ ç¿»è¯‘æ€ç»´é“¾
                        </button>
                    </div>
                    
                    <div class="thought-label">Translation Result</div>
                    <div class="content-body" id="${uniqueId}-trans" style="min-height:80px; color: #94a3b8;">...</div>
                </div>
            </div>
        `;

        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
        document.body.style.overflow = '';
    }

    async function deleteHistory(id, element, event) {
        if(event) event.stopPropagation();
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ–‡ä»¶ä¹Ÿå°†è¢«ç‰©ç†åˆ é™¤ã€‚')) return;
        
        try {
            await fetch(`${API_BASE}/history/${id}`, { method: 'DELETE' });
            element.remove();
            playSound('success'); // Recycled sound
        } catch (e) {
            alert("åˆ é™¤å¤±è´¥");
            playSound('error');
        }
    }

    // --- ç”Ÿæˆé€»è¾‘ ---
    async function startGeneration() {
        const apiKey = document.getElementById('apiKey').value;
        const prompt = document.getElementById('prompt').value;
        if (!apiKey || !prompt) { alert("è¯·å¡«å†™ API Key å’Œ Prompt"); return; }

        const btn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const errorArea = document.getElementById('errorArea');
        
        btn.disabled = true;
        status.textContent = "âœ¨ æ­£åœ¨è¯·æ±‚æœåŠ¡å™¨è¿›è¡Œç”Ÿæˆ...";
        errorArea.innerHTML = '';

        try {
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            const refImagesData = await Promise.all(selectedFiles.map(fileToBase64));
            
            const payload = {
                apiKey: apiKey,
                model: document.getElementById('modelName').value,
                prompt: prompt,
                aspectRatio: document.getElementById('aspectRatio').value || undefined,
                imageSize: document.getElementById('imageSize').value,
                batchSize: 1, // åç«¯ç›®å‰åªå¤„ç†å•æ¬¡è¯·æ±‚ï¼Œå¹¶å‘ç”±å‰ç«¯å¾ªç¯æˆ–åç«¯æ”¹è¿›ï¼Œè¿™é‡Œç®€åŒ–
                refImages: refImagesData,
                temperature: parseFloat(document.getElementById('temperature').value),
                topP: parseFloat(document.getElementById('topP').value),
                // Add jailbreak fields to payload
                jailbreak_enabled: document.getElementById('jailbreakToggle').checked,
                system_instruction_method: document.getElementById('systemInstructionMethod').value,
                system_prompt: document.getElementById('systemPrompt').value,
                forged_response: document.getElementById('forgedResponse').value
            };

            const batchCount = parseInt(document.getElementById('batchSize').value) || 1;
            const mode = document.getElementById('generationMode').value;
            let successCount = 0;

            // æ›´æ–°ç­‰å¾…/è¿›è¡Œä¸­çŠ¶æ€
            globalStats.waiting = batchCount;
            renderStats();

            // å°è£…å•æ¬¡ç”Ÿæˆå‡½æ•°
            const generateOne = async (index) => {
                // çŠ¶æ€æµè½¬: Waiting -> Processing
                globalStats.waiting = Math.max(0, globalStats.waiting - 1);
                globalStats.processing++;
                renderStats();

                try {
                    const res = await fetch(`${API_BASE}/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // å¢å¼ºé”™è¯¯å¤„ç†ï¼šæ£€æŸ¥ HTTP çŠ¶æ€ç 
                    if (!res.ok) {
                        let errorDetail = `æœåŠ¡å™¨é”™è¯¯ (HTTP ${res.status})`;
                        try {
                            const errorJson = await res.json();
                            if (errorJson.detail) {
                                errorDetail = errorJson.detail;
                            }
                        } catch (e) {
                            // å¦‚æœå“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨çŠ¶æ€æ–‡æœ¬
                            errorDetail = `${errorDetail}: ${res.statusText}`;
                        }
                        throw new Error(errorDetail);
                    }

                    const data = await res.json();
                    if(!data.success) throw new Error(data.detail || "Unknown Error");
                    
                    // Processing -> Success
                    globalStats.processing = Math.max(0, globalStats.processing - 1);
                    // Success count ç”± loadStats ç»Ÿä¸€ä»åç«¯åŒæ­¥æ›´å‡†ï¼Œæˆ–è€…è¿™é‡Œé¢„åŠ 
                    // ä¸ºäº†å³æ—¶åé¦ˆå…ˆæ‰‹åŠ¨åŠ 
                    globalStats.success++;
                    globalStats.cost += (data.data.cost || 0);
                    renderStats();

                    return data.data;
                } catch (err) {
                    // Processing -> Failed
                    globalStats.processing = Math.max(0, globalStats.processing - 1);
                    globalStats.failed++;
                    renderStats();
                    throw err;
                }
            };

            if (mode === 'parallel') {
                status.textContent = `âš¡ æ­£åœ¨å¹¶å‘ç”Ÿæˆ ${batchCount} å¼ ...`;
                
                const promises = [];
                for(let i=0; i<batchCount; i++) {
                    promises.push(
                        generateOne(i).then(resultData => {
                            // æˆåŠŸå›è°ƒï¼šç«‹å³æ¸²æŸ“
                            createResultCard(resultData);
                            const gallery = document.getElementById('gallery');
                            gallery.insertBefore(gallery.lastElementChild, gallery.firstElementChild);
                            successCount++;
                            playSound('success');
                            status.textContent = `å¹¶å‘ç”Ÿæˆä¸­... å®Œæˆ ${successCount}/${batchCount}`;
                        })
                    );
                }
                
                // ç­‰å¾…æ‰€æœ‰ï¼ˆåŒ…æ‹¬å¤±è´¥çš„ï¼‰
                const results = await Promise.allSettled(promises);
                
                // æ£€æŸ¥å¹¶æŠ¥å‘Šå¤±è´¥
                const failures = results.filter(r => r.status === 'rejected');
                if (failures.length > 0) {
                    const errorMessages = failures.map(f => `- ${f.reason.message}`).join('<br>');
                    errorArea.innerHTML = `<div class="error-box">å¹¶å‘ä»»åŠ¡ä¸­å‡ºç°é”™è¯¯:<br>${errorMessages}</div>`;
                }
                
                status.textContent = `å¹¶å‘ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚æˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failures.length} å¼ ã€‚`;
                if (failures.length > 0) {
                    playSound('error');
                }

            } else {
                // ä¸²è¡Œ
                for(let i=0; i<batchCount; i++) {
                    status.textContent = `æ­£åœ¨ç”Ÿæˆç¬¬ ${i+1}/${batchCount} å¼ ...`;
                    const resultData = await generateOne(i);
                    
                    createResultCard(resultData);
                    const gallery = document.getElementById('gallery');
                    gallery.insertBefore(gallery.lastElementChild, gallery.firstElementChild);
                    
                    successCount++;
                    playSound('success');
                }
                status.textContent = `ä»»åŠ¡å®Œæˆã€‚æˆåŠŸç”Ÿæˆ ${successCount} å¼ ã€‚`;
            }
            // ä»»åŠ¡ç»“æŸåå†æ¬¡ä»åç«¯åŒæ­¥ä¸€æ¬¡ç²¾ç¡®æ•°æ®
            setTimeout(updateGlobalStats, 1000);

        } catch (e) {
            console.error(e);
            status.textContent = "ç”Ÿæˆå‡ºé”™";
            errorArea.innerHTML = `<div class="error-box">${e.message}</div>`;
            playSound('error');
            // åŒæ­¥æ•°æ®
            setTimeout(updateGlobalStats, 1000);
        } finally {
            // å½’é›¶ç¬æ€çŠ¶æ€ (é˜²æ­¢å¼‚å¸¸å¯¼è‡´å¡ä½)
            globalStats.waiting = 0;
            globalStats.processing = 0;
            renderStats();
            btn.disabled = false;
        }
    }

    async function translateThought(text, outputElem) {
        if (!text || text.trim() === '(æ— æ–‡æœ¬è¾“å‡º)') return;
        outputElem.textContent = "æ­£åœ¨ç¿»è¯‘...";
        try {
            const transModel = document.getElementById('transModelName').value;
            const res = await fetch(`${API_BASE}/translate_thought`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    apiKey: document.getElementById('apiKey').value,
                    model: transModel
                })
            });
            const data = await res.json();
            outputElem.textContent = data.translated || "ç¿»è¯‘å¤±è´¥";
        } catch (e) {
            outputElem.textContent = "ç¿»è¯‘é”™è¯¯: " + e.message;
        }
    }

    // --- å·¥å…·å‡½æ•° ---
    function updateSliderValue(id) {
        const slider = document.getElementById(id);
        const display = document.getElementById(id + 'Value');
        if (slider && display) {
            display.textContent = slider.value;
        }
    }

    function editValue(id, max, step) {
        const display = document.getElementById(id + 'Value');
        const slider = document.getElementById(id);
        const originalValue = display.textContent;
    
        if (display.isEditing) return;
        display.isEditing = true;
    
        const input = document.createElement('input');
        input.type = 'number';
        input.value = originalValue;
        input.max = max;
        input.step = step;
        input.style.width = '60px';
        input.style.padding = '2px';
        input.style.textAlign = 'center';
        input.style.border = '1px solid var(--primary)';
        input.style.background = 'var(--input-bg)';
        input.style.color = 'var(--text)';
        input.style.borderRadius = '4px';
    
        const originalTextContent = display.textContent;
        display.textContent = '';
        display.appendChild(input);
        input.focus();
        input.select();
    
        const finishEditing = () => {
            const newValue = input.value;
            display.removeChild(input); // Remove input first
    
            if (newValue !== null && !isNaN(newValue) && newValue.trim() !== '') {
                let clampedValue = Math.min(max, Math.max(0, parseFloat(newValue)));
                const precision = String(step).includes('.') ? String(step).split('.')[1].length : 2;
                display.textContent = clampedValue.toFixed(precision);
                slider.value = clampedValue;
                triggerAutoSave();
            } else {
                display.textContent = originalTextContent;
            }
            display.isEditing = false;
        };
    
        input.addEventListener('blur', finishEditing);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            } else if (e.key === 'Escape') {
                input.value = originalTextContent;
                input.blur();
            }
        });
    }

    function toggleJailbreakSection() {
        const checkbox = document.getElementById('jailbreakToggle');
        const section = document.getElementById('jailbreakSection');
        section.style.display = checkbox.checked ? 'flex' : 'none';
    }

    const fileToBase64 = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve({
            mime_type: file.type,
            data: reader.result.split(',')[1]
        });
    });
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
    }

    // --- é¢„è®¾ (Presets) ---
    function renderPresets() {
        const container = document.getElementById('presetContainer');
        container.innerHTML = '';
        presets.forEach((p, index) => {
            const tag = document.createElement('div');
            tag.className = 'preset-tag';
            tag.innerHTML = `<span class="preset-name">${p.name}</span><span class="preset-delete" onclick="deletePreset(${index}, event)">&times;</span>`;
            tag.onclick = () => { document.getElementById('prompt').value = p.content; playSound('type'); };
            container.appendChild(tag);
        });
    }
    
    function saveCurrentPrompt() {
        const content = document.getElementById('prompt').value;
        if(!content) return;
        const name = prompt("é¢„è®¾åç§°:", content.substring(0, 10));
        if(name) {
            presets.push({name, content});
            renderPresets();
            triggerAutoSave();
        }
    }
    
    window.deletePreset = (index, e) => {
        e.stopPropagation();
        if(confirm("åˆ é™¤æ­¤é¢„è®¾ï¼Ÿ")) {
            presets.splice(index, 1);
            renderPresets();
            triggerAutoSave();
        }
    };

    // --- éŸ³æ•ˆ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const btnSound = document.getElementById('btnSoundToggle');
    function setupSound() {
        updateSoundBtn();
    }
    function updateSoundBtn() {
        btnSound.textContent = isSoundEnabled ? "ğŸ”” æç¤ºéŸ³: å¼€" : "ğŸ”• æç¤ºéŸ³: å…³";
        btnSound.style.opacity = isSoundEnabled ? "1" : "0.6";
        document.getElementById('volumeSlider').disabled = !isSoundEnabled;
        document.getElementById('volumeSlider').style.opacity = isSoundEnabled ? "1" : "0.5";
    }
    window.toggleSound = () => {
        isSoundEnabled = !isSoundEnabled;
        updateSoundBtn();
        triggerAutoSave();
    };
    function playSound(type) {
        if (!isSoundEnabled || soundVolume == 0) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'success') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(2000, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(soundVolume * 6.4, audioCtx.currentTime + 0.02); // 32x louder
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
            osc.start(); osc.stop(audioCtx.currentTime + 1.5);
        } else if (type === 'error') {
             osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            gain.gain.setValueAtTime(soundVolume * 6.4, audioCtx.currentTime); // 32x louder
            gain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        } else {
             osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            gain.gain.setValueAtTime(soundVolume * 1.6, audioCtx.currentTime); // 32x louder
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }
    }

    // --- æ–‡ä»¶ä¸Šä¼ UI ---
    window.handleFileSelect = (input) => {
        const files = Array.from(input.files);
        if (selectedFiles.length + files.length > 14) { alert("æœ€å¤š14å¼ "); return; }
        selectedFiles = [...selectedFiles, ...files];
        renderPreviews();
        input.value = '';
    };
    
    function renderPreviews() {
        const container = document.getElementById('filePreview');
        container.innerHTML = '';
        document.getElementById('fileCount').textContent = selectedFiles.length;
        selectedFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<img src="${URL.createObjectURL(file)}"><div class="preview-remove" onclick="removeFile(${index})">&times;</div>`;
            container.appendChild(div);
        });
    }
    
    window.removeFile = (index) => {
        selectedFiles.splice(index, 1);
        renderPreviews();
    };

    // --- å›¾ç‰‡æ¨¡æ€æ¡† (ç¼©æ”¾æ‹–æ‹½) ---
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById("modalImg");
    let scale = 1;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;

    window.openModal = (src) => {
        modal.style.display = "block";
        modalImg.src = src;
        // Reset state
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
    };
    window.closeModal = () => { modal.style.display = "none"; };

    // Zoom with wheel (Zoom to cursor)
    modal.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        // ç¼©æ”¾ç³»æ•°
        const factor = e.deltaY > 0 ? 0.9 : 1.1;
        let newScale = scale * factor;
        
        // é™åˆ¶ç¼©æ”¾èŒƒå›´
        if (newScale < 0.1) newScale = 0.1;
        if (newScale > 20) newScale = 20;

        // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºè§†å£ä¸­å¿ƒçš„åç§»é‡
        const rect = document.getElementById('modalViewport').getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        // é¼ æ ‡åæ ‡ (ç›¸å¯¹äºè§†å£ä¸­å¿ƒ)
        const mx = e.clientX - rect.left - centerX;
        const my = e.clientY - rect.top - centerY;

        // è®¡ç®—æ–°çš„ä½ç§»ï¼Œä¿æŒé¼ æ ‡æŒ‡å‘çš„å›¾ç‰‡ç‚¹ä½ç½®ä¸å˜
        // å…¬å¼: new_trans = mouse - (mouse - old_trans) * (new_scale / old_scale)
        const scaleRatio = newScale / scale;
        translateX = mx - (mx - translateX) * scaleRatio;
        translateY = my - (my - translateY) * scaleRatio;

        scale = newScale;
        updateTransform();
    });

    // Drag
    modalImg.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        modalImg.style.cursor = 'grabbing';
        e.preventDefault(); // Prevent default drag behavior
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateTransform();
    });

    window.addEventListener('mouseup', () => {
        isDragging = false;
        modalImg.style.cursor = 'grab';
    });

    function updateTransform() {
        modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    // Run
    init();

</script>
</body>
</html>